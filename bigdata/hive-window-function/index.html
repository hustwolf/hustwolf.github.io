<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>hive中的window function详解 | hustwolf's blog</title><meta name="author" content="hustwolf"><meta name="copyright" content="hustwolf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基本概念窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系； 概念 (Partition BY Order BY ROW|RANGE BETWEEN Windowing specification) window framewinfow frame决定了对于当前row来说，window function应该作用在那个r">
<meta property="og:type" content="article">
<meta property="og:title" content="hive中的window function详解">
<meta property="og:url" content="https://hustwolf.github.io/bigdata/hive-window-function/index.html">
<meta property="og:site_name" content="hustwolf&#39;s blog">
<meta property="og:description" content="基本概念窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系； 概念 (Partition BY Order BY ROW|RANGE BETWEEN Windowing specification) window framewinfow frame决定了对于当前row来说，window function应该作用在那个r">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-02T01:58:31.000Z">
<meta property="article:modified_time" content="2021-04-02T01:58:31.000Z">
<meta property="article:author" content="hustwolf">
<meta property="article:tag" content="hive">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hustwolf.github.io/bigdata/hive-window-function/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'hive中的window function详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-02 09:58:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">hustwolf's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">hive中的window function详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-02T01:58:31.000Z" title="发表于 2021-04-02 09:58:31">2021-04-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-02T01:58:31.000Z" title="更新于 2021-04-02 09:58:31">2021-04-02</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="hive中的window function详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系；</p>
<p>概念<br><img src="/bigdata/hive-window-function/concepts.png" alt="concepts"></p>
<p>(Partition BY Order BY ROW|RANGE BETWEEN Windowing specification)</p>
<h3 id="window-frame"><a href="#window-frame" class="headerlink" title="window frame"></a>window frame</h3><p>winfow frame决定了对于当前row来说，window function应该作用在那个row范围里</p>
<h4 id="range-vs-rows"><a href="#range-vs-rows" class="headerlink" title="range vs rows"></a>range vs rows</h4><p>如果order by 没有windows frame clause， 那么window 为<br>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</p>
<p>如果order by 与 window clause 都没有<br>那就是 </p>
<p>ROW BETWEEN UNBOUNDED PRECEGING AND UNBOUNDED FOLLOWING</p>
<blockquote>
<p>When ORDER BY is specified with missing WINDOW clause, the WINDOW specification defaults to RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.</p>
<p>When both ORDER BY and WINDOW clauses are missing, the WINDOW specification defaults to ROW BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING.</p>
</blockquote>
<ul>
<li>可以使用的类型<br>所有window function的计算都是基于当前frame的</li>
</ul>
<p>|type| function | sample|desc|case|<br>| ————- |:————-:| —–:| —–:||<br>|windowing function|LEAD(col,n,DEFAULT)|LEAD(10)|在current row之后的第n条记录||<br>|windowing function|LAG(col,n,DEFAULT)|LAG(10)|在current row之前的第n条记录||<br>|windowing function|FIRST_VALUE|FIRST_VALUE(column)|返回window中column的第一条记录||<br>|windowing function|FIRST_VALUE|LAST_VALUE(column)|返回window中column的最后一条记录||<br>|  || |||<br>|Analytics function|RANK|RANK()|排序号,如果要一样的，那么返回一样的值，但是下一个序号就给省略了，比如 1，1，3这种||<br>|Analytics function|ROW_NUMBER|ROW_NUMBER()|直接就是row number||<br>|Analytics function|DENSE_RANK|DENSE_RANK()|类似rank，但是返回连续的1，1，2这种||<br>|Analytics function|CUME_DIST|CUME_DIST() | 小于等于当前值的行数&#x2F;分组内总行数,算是某种算分布的算法|比如，统计小于等于当前薪水的人数，所占总人数的比例|<br>|Analytics function|PERCENT_RANK|分组内当前行的RANK值-1&#x2F;分组内总行数-1||<br>|Analytics function|NTILE|NTILE(5)|把frame按照顺序分组为n份，然后返回当前分组的序号，如果不整除，默认增加第1个分组的量；其实某种程序来说，这也算是一个rank方法|<br>|  || ||<br>|aggregates function|COUNT|count(column)||<br>|aggregates function|SUM|||<br>|aggregates function|MIN|||<br>|aggregates function|MAX|||<br>|aggregates function|AVG|||</p>
<p>window也可以有aliases<br>比如 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, <span class="built_in">SUM</span>(b) <span class="keyword">OVER</span> w</span><br><span class="line"><span class="keyword">FROM</span> T</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> c <span class="keyword">ORDER</span> <span class="keyword">BY</span> d <span class="keyword">ROWS</span> UNBOUNDED PRECEDING);</span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><ul>
<li>连续活跃7天的用户</li>
</ul>
<p>表定义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_log`(</span><br><span class="line">  `user_id` string,</span><br><span class="line">  `active_date` string)</span><br><span class="line"><span class="type">ROW</span> FORMAT SERDE</span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcSerde&#x27;</span></span><br><span class="line">STORED <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcInputFormat&#x27;</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">  <span class="string">&#x27;org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat&#x27;</span></span><br><span class="line">LOCATION</span><br><span class="line">  <span class="string">&#x27;hdfs://nameservice1/user/hive/warehouse/temp.db/user_log&#x27;</span></span><br><span class="line">TBLPROPERTIES (</span><br><span class="line">  <span class="string">&#x27;transient_lastDdlTime&#x27;</span><span class="operator">=</span><span class="string">&#x27;1594371755&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>基本思想是选择每个用户7天的滑窗，只有在条数为7并且日期差为6的时候，就是连续活跃7天；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">        active_date,</span><br><span class="line">        <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">OVER</span> `w`                                                      <span class="keyword">AS</span> count,</span><br><span class="line">        datediff(<span class="built_in">last_value</span>(active_date) <span class="keyword">OVER</span> `w`, <span class="built_in">first_value</span>(active_date) <span class="keyword">OVER</span> `w`) <span class="keyword">as</span> diff</span><br><span class="line"><span class="comment">--               ,count(*) over (partition by user_id order by active_date) as count_now</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                        active_date</span><br><span class="line">            <span class="keyword">FROM</span>     user_log</span><br><span class="line">            <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                        active_date</span><br><span class="line">        ) user_log_1</span><br><span class="line">            <span class="keyword">window</span> `w` <span class="keyword">AS</span></span><br><span class="line">            <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">            (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">row</span> <span class="keyword">AND</span>  <span class="number">6</span> following)</span><br></pre></td></tr></table></figure>
<p>注意我注释掉了一行，待会说这个的作用，结果为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff</span><br><span class="line">1	2020-05-01	7	7</span><br><span class="line">1	2020-05-02	7	7</span><br><span class="line">1	2020-05-04	7	6</span><br><span class="line">1	2020-05-05	7	6</span><br><span class="line">1	2020-05-06	7	8</span><br><span class="line">1	2020-05-07	7	15</span><br><span class="line">1	2020-05-08	6	14</span><br><span class="line">1	2020-05-09	5	13</span><br><span class="line">1	2020-05-10	4	12</span><br><span class="line">1	2020-05-11	3	11</span><br><span class="line">1	2020-05-14	2	8</span><br><span class="line">1	2020-05-22	1	0</span><br><span class="line">2	2020-05-02	3	18</span><br><span class="line">2	2020-05-04	3	18</span><br><span class="line">2	2020-05-20	3	18</span><br><span class="line">3	2020-05-02	2	6</span><br><span class="line">3	2020-05-08	2	6</span><br><span class="line">4	2020-05-02	3	20</span><br><span class="line">4	2020-05-08	3	20</span><br><span class="line">4	2020-05-22	3	20</span><br><span class="line">5	2020-05-10	1	0</span><br><span class="line">6	2020-05-01	7	7</span><br><span class="line">6	2020-05-02	7	7</span><br><span class="line">6	2020-05-04	7	6</span><br><span class="line">6	2020-05-05	7	6</span><br><span class="line">6	2020-05-06	7	8</span><br><span class="line">6	2020-05-07	7	15</span><br><span class="line">6	2020-05-08	6	14</span><br><span class="line">6	2020-05-09	5	13</span><br><span class="line">6	2020-05-10	4	12</span><br><span class="line">6	2020-05-11	3	11</span><br><span class="line">6	2020-05-14	2	8</span><br><span class="line">6	2020-05-22	1	0</span><br></pre></td></tr></table></figure>
<p>id为1与6的这些count与diff没有问题，但是id为2，3，4这些不满足一个滑窗的数据有错误；其count应该连续下降，以及diff最后一个值应该是0；<br>这大概是hive的bug吧；<br>据说有一种方法是，再增加一个滑窗，我们把sql里的注释去掉，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">        active_date,</span><br><span class="line">        <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">OVER</span> `w`                                                      <span class="keyword">AS</span> count,</span><br><span class="line">        datediff(<span class="built_in">last_value</span>(active_date) <span class="keyword">OVER</span> `w`, <span class="built_in">first_value</span>(active_date) <span class="keyword">OVER</span> `w`) <span class="keyword">as</span> diff</span><br><span class="line">              ,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date) <span class="keyword">as</span> count_now</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                        active_date</span><br><span class="line">            <span class="keyword">FROM</span>     user_log</span><br><span class="line">            <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                        active_date</span><br><span class="line">        ) user_log_1</span><br><span class="line">            <span class="keyword">window</span> `w` <span class="keyword">AS</span></span><br><span class="line">            <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">            (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">row</span> <span class="keyword">AND</span>  <span class="number">6</span> following)</span><br></pre></td></tr></table></figure>
<p>结果为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff	count_now</span><br><span class="line">1	2020-05-01	7	7	1</span><br><span class="line">1	2020-05-02	7	7	2</span><br><span class="line">1	2020-05-04	7	6	3</span><br><span class="line">1	2020-05-05	7	6	4</span><br><span class="line">1	2020-05-06	7	8	5</span><br><span class="line">1	2020-05-07	7	15	6</span><br><span class="line">1	2020-05-08	6	14	7</span><br><span class="line">1	2020-05-09	5	13	8</span><br><span class="line">1	2020-05-10	4	12	9</span><br><span class="line">1	2020-05-11	3	11	10</span><br><span class="line">1	2020-05-14	2	8	11</span><br><span class="line">1	2020-05-22	1	0	12</span><br><span class="line">2	2020-05-02	3	18	1</span><br><span class="line">2	2020-05-04	2	16	2</span><br><span class="line">2	2020-05-20	1	0	3</span><br><span class="line">3	2020-05-02	2	6	1</span><br><span class="line">3	2020-05-08	1	0	2</span><br><span class="line">4	2020-05-02	3	20	1</span><br><span class="line">4	2020-05-08	2	14	2</span><br><span class="line">4	2020-05-22	1	0	3</span><br><span class="line">5	2020-05-10	1	0	1</span><br><span class="line">6	2020-05-01	7	7	1</span><br><span class="line">6	2020-05-02	7	7	2</span><br><span class="line">6	2020-05-04	7	6	3</span><br><span class="line">6	2020-05-05	7	6	4</span><br><span class="line">6	2020-05-06	7	8	5</span><br><span class="line">6	2020-05-07	7	15	6</span><br><span class="line">6	2020-05-08	6	14	7</span><br><span class="line">6	2020-05-09	5	13	8</span><br><span class="line">6	2020-05-10	4	12	9</span><br><span class="line">6	2020-05-11	3	11	10</span><br><span class="line">6	2020-05-14	2	8	11</span><br><span class="line">6	2020-05-22	1	0	12</span><br></pre></td></tr></table></figure>
<p>所以我怀疑hive是在check不超过一个滑窗时，就没有对数据进行排序了。为了验证我的思想，我把id&#x3D;2的数据增加到了7条，id&#x3D;3的数据增加到了6条，id&#x3D;4的数据增加到了5条<br>再次运行不带额外窗口的sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff</span><br><span class="line">1	2020-05-01	7	7</span><br><span class="line">1	2020-05-02	7	7</span><br><span class="line">1	2020-05-04	7	6</span><br><span class="line">1	2020-05-05	7	6</span><br><span class="line">1	2020-05-06	7	8</span><br><span class="line">1	2020-05-07	7	15</span><br><span class="line">1	2020-05-08	6	14</span><br><span class="line">1	2020-05-09	5	13</span><br><span class="line">1	2020-05-10	4	12</span><br><span class="line">1	2020-05-11	3	11</span><br><span class="line">1	2020-05-14	2	8</span><br><span class="line">1	2020-05-22	1	0</span><br><span class="line">2	2020-05-02	7	18</span><br><span class="line">2	2020-05-04	6	16</span><br><span class="line">2	2020-05-07	5	13</span><br><span class="line">2	2020-05-08	4	12</span><br><span class="line">2	2020-05-09	3	11</span><br><span class="line">2	2020-05-10	2	10</span><br><span class="line">2	2020-05-20	1	0</span><br><span class="line">3	2020-05-01	6	9</span><br><span class="line">3	2020-05-02	5	8</span><br><span class="line">3	2020-05-04	4	6</span><br><span class="line">3	2020-05-07	3	3</span><br><span class="line">3	2020-05-08	2	2</span><br><span class="line">3	2020-05-10	1	0</span><br><span class="line">4	2020-05-01	5	21</span><br><span class="line">4	2020-05-02	5	21</span><br><span class="line">4	2020-05-04	4	20</span><br><span class="line">4	2020-05-08	3	18</span><br><span class="line">4	2020-05-22	2	14</span><br><span class="line">5	2020-05-10	1	0</span><br><span class="line">6	2020-05-01	7	7</span><br><span class="line">6	2020-05-02	7	7</span><br><span class="line">6	2020-05-04	7	6</span><br><span class="line">6	2020-05-05	7	6</span><br><span class="line">6	2020-05-06	7	8</span><br><span class="line">6	2020-05-07	7	15</span><br><span class="line">6	2020-05-08	6	14</span><br><span class="line">6	2020-05-09	5	13</span><br><span class="line">6	2020-05-10	4	12</span><br><span class="line">6	2020-05-11	3	11</span><br><span class="line">6	2020-05-14	2	8</span><br><span class="line">6	2020-05-22	1	0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果还是有bug；所以为了稳妥起见，还是带上额外的窗口吧<br>完整版的sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (</span><br><span class="line">        <span class="keyword">SELECT</span> user_id,</span><br><span class="line">               active_date,</span><br><span class="line">               <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">OVER</span> `w`                                                      <span class="keyword">AS</span> count,</span><br><span class="line">               datediff(<span class="built_in">last_value</span>(active_date) <span class="keyword">OVER</span> `w`, <span class="built_in">first_value</span>(active_date) <span class="keyword">OVER</span> `w`) <span class="keyword">as</span> diff</span><br><span class="line">              ,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date) <span class="keyword">as</span> count_now</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">               <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                 <span class="keyword">window</span> `w` <span class="keyword">AS</span></span><br><span class="line">                 <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">                 (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">row</span> <span class="keyword">AND</span>  <span class="number">6</span> following)</span><br><span class="line">     ) user_log2</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> count<span class="operator">=</span><span class="number">7</span></span><br><span class="line"><span class="keyword">AND</span>   diff<span class="operator">=</span><span class="number">6</span> <span class="comment">-- 过滤出滑动窗口里有7天以及差值为6天的数据</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_id</span><br><span class="line">1</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>这里的取巧在于，我们已经知道窗口大小，设置为7天，但是如果我们不知道滑窗大小呢？比如下一题</p>
<ul>
<li>用户的连续活跃最大天数<br>还是以上的数据集，这种时候窗口大小肯定是整个partition，但是我们注意到如果日期是连续的，那么他们的 date 减去 row number，如果得到的结果相同，那么就是连续的数据<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">                active_date,</span><br><span class="line">                date_sub(active_date, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span> `w` ) <span class="keyword">as</span> base_date</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">                <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                    <span class="keyword">window</span> `w` <span class="keyword">AS</span> (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date )</span><br></pre></td></tr></table></figure>
结果为<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	base_date</span><br><span class="line">1	2020-05-01	2020-04-30</span><br><span class="line">1	2020-05-02	2020-04-30</span><br><span class="line">1	2020-05-04	2020-05-01</span><br><span class="line">1	2020-05-05	2020-05-01</span><br><span class="line">1	2020-05-06	2020-05-01</span><br><span class="line">1	2020-05-07	2020-05-01</span><br><span class="line">1	2020-05-08	2020-05-01</span><br><span class="line">1	2020-05-09	2020-05-01</span><br><span class="line">1	2020-05-10	2020-05-01</span><br><span class="line">1	2020-05-11	2020-05-01</span><br><span class="line">1	2020-05-14	2020-05-03</span><br><span class="line">1	2020-05-22	2020-05-10</span><br><span class="line">2	2020-05-02	2020-05-01</span><br><span class="line">2	2020-05-04	2020-05-02</span><br><span class="line">2	2020-05-07	2020-05-04</span><br><span class="line">2	2020-05-08	2020-05-04</span><br><span class="line">2	2020-05-09	2020-05-04</span><br><span class="line">2	2020-05-10	2020-05-04</span><br><span class="line">2	2020-05-20	2020-05-13</span><br><span class="line">3	2020-05-01	2020-04-30</span><br><span class="line">3	2020-05-02	2020-04-30</span><br><span class="line">3	2020-05-04	2020-05-01</span><br><span class="line">3	2020-05-07	2020-05-03</span><br><span class="line">3	2020-05-08	2020-05-03</span><br><span class="line">3	2020-05-10	2020-05-04</span><br><span class="line">4	2020-05-01	2020-04-30</span><br><span class="line">4	2020-05-02	2020-04-30</span><br><span class="line">4	2020-05-04	2020-05-01</span><br><span class="line">4	2020-05-08	2020-05-04</span><br><span class="line">4	2020-05-22	2020-05-17</span><br><span class="line">5	2020-05-10	2020-05-09</span><br><span class="line">6	2020-05-01	2020-04-30</span><br><span class="line">6	2020-05-02	2020-04-30</span><br><span class="line">6	2020-05-04	2020-05-01</span><br><span class="line">6	2020-05-05	2020-05-01</span><br><span class="line">6	2020-05-06	2020-05-01</span><br><span class="line">6	2020-05-07	2020-05-01</span><br><span class="line">6	2020-05-08	2020-05-01</span><br><span class="line">6	2020-05-09	2020-05-01</span><br><span class="line">6	2020-05-10	2020-05-01</span><br><span class="line">6	2020-05-11	2020-05-01</span><br><span class="line">6	2020-05-14	2020-05-03</span><br><span class="line">6	2020-05-22	2020-05-10</span><br></pre></td></tr></table></figure>
所以完整版也呼之欲出了<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id, <span class="built_in">max</span>(count)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> count</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        (<span class="keyword">SELECT</span> user_id,</span><br><span class="line">                active_date,</span><br><span class="line">                date_sub(active_date, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span> `w` ) <span class="keyword">as</span> base_date</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">                <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                    <span class="keyword">window</span> `w` <span class="keyword">AS</span> (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date )</span><br><span class="line">        )user_log_2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id, base_date) user_log_3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br></pre></td></tr></table></figure>
结果为<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user_id	_c1</span><br><span class="line">1	8</span><br><span class="line">2	4</span><br><span class="line">3	2</span><br><span class="line">4	2</span><br><span class="line">5	1</span><br><span class="line">6	8</span><br></pre></td></tr></table></figure>
用这种方法找连续活跃7天的数据也是ok的。</li>
<li>其他的方法<br>我们知道在指定滑窗大小的时候，可以使用row，代表往前或者往后的多少条，是固定的，与业务数据无关；是否可以根据记录的数值，来动态的选择滑窗的大小呢？<br>range就是这样，<br>RANGE BETWEEN 100 PRECEDING AND 200 FOLLOWING ；假如当前值为 200，那么就会选择字段落在100到400间的记录</li>
</ul>
<p>可以把时间转换为数字然后利用range取到一周的区间，看是否有7条记录也ok</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (</span><br><span class="line">        <span class="keyword">SELECT</span> user_id,</span><br><span class="line">               active_date,</span><br><span class="line">               <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">OVER</span> `w` <span class="keyword">AS</span> count_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">        <span class="keyword">window</span> `w`</span><br><span class="line">        <span class="comment">-- 取一个range 区间，是按照order by 来排序的</span></span><br><span class="line">        <span class="keyword">as</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> unix_timestamp(active_date, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>) <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">518400</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>)</span><br><span class="line">     ) user_log2</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> count_date <span class="operator">=</span> <span class="number">7</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_id</span><br><span class="line">1</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>说到底，这是一种如何定义窗口跟利用hql的语言使用窗口的语言；来，我们看看如何在spark、flink这些语言中，定义与使用窗口</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics">hive官网说明</a></li>
<li><a target="_blank" rel="noopener" href="http://shzhangji.com/blog/2017/09/04/hive-window-and-analytical-functions/">http://shzhangji.com/blog/2017/09/04/hive-window-and-analytical-functions/</a></li>
<li><a target="_blank" rel="noopener" href="http://lxw1234.com/archives/tag/hive-window-functions">http://lxw1234.com/archives/tag/hive-window-functions</a><br>重点可以看他的window specification说明</li>
<li><a target="_blank" rel="noopener" href="https://bigdataprogrammers.com/windowing-functions-in-hive/">https://bigdataprogrammers.com/windowing-functions-in-hive/</a></li>
</ul>
<p>关于如何使用range window frame</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://bill.crook.io/blog/2014/10/24/date-based-windowing-functions-in-hive/">http://bill.crook.io/blog/2014/10/24/date-based-windowing-functions-in-hive/</a></li>
</ul>
<blockquote>
<p>The window ranges today are numeric constants, whereas, in the spec, you can have arbitrary numerical expressions. And in Hive, you don’t have date intervals. So if you want to do date-based windows, you pretty much have to break down the date into components, and treat each component as a int.</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://hustwolf.github.io">hustwolf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hustwolf.github.io/bigdata/hive-window-function/">https://hustwolf.github.io/bigdata/hive-window-function/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hustwolf.github.io" target="_blank">hustwolf's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/hive/">hive</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpeg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpeg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/interview/bigdata1/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">临近点均值法缺失值填充</div></div></a></div><div class="next-post pull-right"><a href="/tools/math-script/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">数学公式</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/bigdata/hive-order-by/" title="hive order by"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-11</div><div class="title">hive order by</div></div></a></div><div><a href="/bigdata/hql-execute/" title="hql-execute"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-16</div><div class="title">hql-execute</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">hustwolf</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hustwolf"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">welcome to my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#window-frame"><span class="toc-number">1.2.</span> <span class="toc-text">window frame</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#range-vs-rows"><span class="toc-number">1.2.1.</span> <span class="toc-text">range vs rows</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">3.</span> <span class="toc-text">链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/java/order-run/" title="顺序执行"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="顺序执行"/></a><div class="content"><a class="title" href="/java/order-run/" title="顺序执行">顺序执行</a><time datetime="2022-11-27T16:00:00.000Z" title="发表于 2022-11-28 00:00:00">2022-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bigdata/kafka/" title="kafka"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kafka"/></a><div class="content"><a class="title" href="/bigdata/kafka/" title="kafka">kafka</a><time datetime="2022-11-24T08:05:35.000Z" title="发表于 2022-11-24 16:05:35">2022-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/algorithm/coin-change/" title="零钱兑换"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="零钱兑换"/></a><div class="content"><a class="title" href="/algorithm/coin-change/" title="零钱兑换">零钱兑换</a><time datetime="2022-11-23T16:00:00.000Z" title="发表于 2022-11-24 00:00:00">2022-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/java/forkjoinpool/" title="forkjoinpool"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="forkjoinpool"/></a><div class="content"><a class="title" href="/java/forkjoinpool/" title="forkjoinpool">forkjoinpool</a><time datetime="2022-11-21T09:26:07.000Z" title="发表于 2022-11-21 17:26:07">2022-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/interview/bigdata1/" title="临近点均值法缺失值填充"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="临近点均值法缺失值填充"/></a><div class="content"><a class="title" href="/interview/bigdata1/" title="临近点均值法缺失值填充">临近点均值法缺失值填充</a><time datetime="2022-11-05T16:00:00.000Z" title="发表于 2022-11-06 00:00:00">2022-11-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By hustwolf</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>