<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="hive中的window function详解"/>




  <meta name="keywords" content="hive," />





  <link rel="alternate" href="/default" title="hustwolf's blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="https://hustwolf.github.io/2020/07/11/bigdata/hive-window-function/"/>


<meta name="description" content="基本概念窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系； 概念 (Partition BY Order BY ROW|RANGE BETWEEN Windowing specification) window framewinfow frame决定了对于当前row来说，window function应该作用在那个r">
<meta property="og:type" content="article">
<meta property="og:title" content="hive中的window function详解">
<meta property="og:url" content="https://hustwolf.github.io/2020/07/11/bigdata/hive-window-function/index.html">
<meta property="og:site_name" content="hustwolf&#39;s blog">
<meta property="og:description" content="基本概念窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系； 概念 (Partition BY Order BY ROW|RANGE BETWEEN Windowing specification) window framewinfow frame决定了对于当前row来说，window function应该作用在那个r">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hustwolf.github.io/2020/07/11/bigdata/hive-window-function/concepts.png">
<meta property="article:published_time" content="2020-07-11T02:09:33.216Z">
<meta property="article:modified_time" content="2020-07-16T06:07:35.951Z">
<meta property="article:author" content="hustwolf">
<meta property="article:tag" content="hive">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hustwolf.github.io/2020/07/11/bigdata/hive-window-function/concepts.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?wolfinhust";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



    <title> hive中的window function详解 - hustwolf's blog </title>
  <meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">hustwolf's blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          hive中的window function详解
        
      </h1>

      <time class="post-time">
          7月 11 2020
      </time>
    </header>



    
            <div class="post-content">
            <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>窗口聚合函数 是指那些在一个window(很多个记录)内进行计算的函数，而这个window的又和current row有很大的关系；</p>
<p>概念<br><img src="../hive-window-function/concepts.png" alt="concepts"></p>
<p>(Partition BY Order BY ROW|RANGE BETWEEN Windowing specification)</p>
<h3 id="window-frame"><a href="#window-frame" class="headerlink" title="window frame"></a>window frame</h3><p>winfow frame决定了对于当前row来说，window function应该作用在那个row范围里</p>
<h4 id="range-vs-rows"><a href="#range-vs-rows" class="headerlink" title="range vs rows"></a>range vs rows</h4><p>如果order by 没有windows frame clause， 那么window 为<br>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</p>
<p>如果order by 与 window clause 都没有<br>那就是 </p>
<p>ROW BETWEEN UNBOUNDED PRECEGING AND UNBOUNDED FOLLOWING</p>
<blockquote>
<p>When ORDER BY is specified with missing WINDOW clause, the WINDOW specification defaults to RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.</p>
<p>When both ORDER BY and WINDOW clauses are missing, the WINDOW specification defaults to ROW BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING.</p>
</blockquote>
<ul>
<li>可以使用的类型<br>所有window function的计算都是基于当前frame的</li>
</ul>
<table>
<thead>
<tr>
<th>type</th>
<th align="center">function</th>
<th align="right">sample</th>
<th align="right">desc</th>
<th>case</th>
</tr>
</thead>
<tbody><tr>
<td>windowing function</td>
<td align="center">LEAD(col,n,DEFAULT)</td>
<td align="right">LEAD(10)</td>
<td align="right">在current row之后的第n条记录</td>
<td></td>
</tr>
<tr>
<td>windowing function</td>
<td align="center">LAG(col,n,DEFAULT)</td>
<td align="right">LAG(10)</td>
<td align="right">在current row之前的第n条记录</td>
<td></td>
</tr>
<tr>
<td>windowing function</td>
<td align="center">FIRST_VALUE</td>
<td align="right">FIRST_VALUE(column)</td>
<td align="right">返回window中column的第一条记录</td>
<td></td>
</tr>
<tr>
<td>windowing function</td>
<td align="center">FIRST_VALUE</td>
<td align="right">LAST_VALUE(column)</td>
<td align="right">返回window中column的最后一条记录</td>
<td></td>
</tr>
<tr>
<td></td>
<td align="center"></td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">RANK</td>
<td align="right">RANK()</td>
<td align="right">排序号,如果要一样的，那么返回一样的值，但是下一个序号就给省略了，比如 1，1，3这种</td>
<td></td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">ROW_NUMBER</td>
<td align="right">ROW_NUMBER()</td>
<td align="right">直接就是row number</td>
<td></td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">DENSE_RANK</td>
<td align="right">DENSE_RANK()</td>
<td align="right">类似rank，但是返回连续的1，1，2这种</td>
<td></td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">CUME_DIST</td>
<td align="right">CUME_DIST()</td>
<td align="right">小于等于当前值的行数/分组内总行数,算是某种算分布的算法</td>
<td>比如，统计小于等于当前薪水的人数，所占总人数的比例</td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">PERCENT_RANK</td>
<td align="right">分组内当前行的RANK值-1/分组内总行数-1</td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>Analytics function</td>
<td align="center">NTILE</td>
<td align="right">NTILE(5)</td>
<td align="right">把frame按照顺序分组为n份，然后返回当前分组的序号，如果不整除，默认增加第1个分组的量；其实某种程序来说，这也算是一个rank方法</td>
<td></td>
</tr>
<tr>
<td></td>
<td align="center"></td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>aggregates function</td>
<td align="center">COUNT</td>
<td align="right">count(column)</td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>aggregates function</td>
<td align="center">SUM</td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>aggregates function</td>
<td align="center">MIN</td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>aggregates function</td>
<td align="center">MAX</td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td>aggregates function</td>
<td align="center">AVG</td>
<td align="right"></td>
<td align="right"></td>
<td></td>
</tr>
</tbody></table>
<p>window也可以有aliases<br>比如 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a, <span class="keyword">SUM</span>(b) <span class="keyword">OVER</span> w</span><br><span class="line"><span class="keyword">FROM</span> T</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> c <span class="keyword">ORDER</span> <span class="keyword">BY</span> d <span class="keyword">ROWS</span> <span class="keyword">UNBOUNDED</span> <span class="keyword">PRECEDING</span>);</span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><ul>
<li>连续活跃7天的用户</li>
</ul>
<p>表定义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_log`</span>(</span><br><span class="line">  <span class="string">`user_id`</span> <span class="keyword">string</span>,</span><br><span class="line">  <span class="string">`active_date`</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> SERDE</span><br><span class="line">  <span class="string">'org.apache.hadoop.hive.ql.io.orc.OrcSerde'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT</span><br><span class="line">  <span class="string">'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'</span></span><br><span class="line">OUTPUTFORMAT</span><br><span class="line">  <span class="string">'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'</span></span><br><span class="line">LOCATION</span><br><span class="line">  <span class="string">'hdfs://nameservice1/user/hive/warehouse/temp.db/user_log'</span></span><br><span class="line">TBLPROPERTIES (</span><br><span class="line">  <span class="string">'transient_lastDdlTime'</span>=<span class="string">'1594371755'</span>)</span><br></pre></td></tr></table></figure>

<p>基本思想是选择每个用户7天的滑窗，只有在条数为7并且日期差为6的时候，就是连续活跃7天；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">        active_date,</span><br><span class="line">        <span class="keyword">count</span>(*) <span class="keyword">OVER</span> <span class="string">`w`</span>                                                      <span class="keyword">AS</span> <span class="keyword">count</span>,</span><br><span class="line">        <span class="keyword">datediff</span>(<span class="keyword">last_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>, <span class="keyword">first_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>) <span class="keyword">as</span> diff</span><br><span class="line"><span class="comment">--               ,count(*) over (partition by user_id order by active_date) as count_now</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                        active_date</span><br><span class="line">            <span class="keyword">FROM</span>     user_log</span><br><span class="line">            <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                        active_date</span><br><span class="line">        ) user_log_1</span><br><span class="line">            <span class="keyword">window</span> <span class="string">`w`</span> <span class="keyword">AS</span></span><br><span class="line">            <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">            (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="keyword">row</span> <span class="keyword">AND</span>  <span class="number">6</span> <span class="keyword">following</span>)</span><br></pre></td></tr></table></figure>
<p>注意我注释掉了一行，待会说这个的作用，结果为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff</span><br><span class="line">1	2020-05-01	7	7</span><br><span class="line">1	2020-05-02	7	7</span><br><span class="line">1	2020-05-04	7	6</span><br><span class="line">1	2020-05-05	7	6</span><br><span class="line">1	2020-05-06	7	8</span><br><span class="line">1	2020-05-07	7	15</span><br><span class="line">1	2020-05-08	6	14</span><br><span class="line">1	2020-05-09	5	13</span><br><span class="line">1	2020-05-10	4	12</span><br><span class="line">1	2020-05-11	3	11</span><br><span class="line">1	2020-05-14	2	8</span><br><span class="line">1	2020-05-22	1	0</span><br><span class="line">2	2020-05-02	3	18</span><br><span class="line">2	2020-05-04	3	18</span><br><span class="line">2	2020-05-20	3	18</span><br><span class="line">3	2020-05-02	2	6</span><br><span class="line">3	2020-05-08	2	6</span><br><span class="line">4	2020-05-02	3	20</span><br><span class="line">4	2020-05-08	3	20</span><br><span class="line">4	2020-05-22	3	20</span><br><span class="line">5	2020-05-10	1	0</span><br><span class="line">6	2020-05-01	7	7</span><br><span class="line">6	2020-05-02	7	7</span><br><span class="line">6	2020-05-04	7	6</span><br><span class="line">6	2020-05-05	7	6</span><br><span class="line">6	2020-05-06	7	8</span><br><span class="line">6	2020-05-07	7	15</span><br><span class="line">6	2020-05-08	6	14</span><br><span class="line">6	2020-05-09	5	13</span><br><span class="line">6	2020-05-10	4	12</span><br><span class="line">6	2020-05-11	3	11</span><br><span class="line">6	2020-05-14	2	8</span><br><span class="line">6	2020-05-22	1	0</span><br></pre></td></tr></table></figure>
<p>id为1与6的这些count与diff没有问题，但是id为2，3，4这些不满足一个滑窗的数据有错误；其count应该连续下降，以及diff最后一个值应该是0；<br>这大概是hive的bug吧；<br>据说有一种方法是，再增加一个滑窗，我们把sql里的注释去掉，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">        active_date,</span><br><span class="line">        <span class="keyword">count</span>(*) <span class="keyword">OVER</span> <span class="string">`w`</span>                                                      <span class="keyword">AS</span> <span class="keyword">count</span>,</span><br><span class="line">        <span class="keyword">datediff</span>(<span class="keyword">last_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>, <span class="keyword">first_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>) <span class="keyword">as</span> diff</span><br><span class="line">              ,<span class="keyword">count</span>(*) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date) <span class="keyword">as</span> count_now</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">        (</span><br><span class="line">            <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                        active_date</span><br><span class="line">            <span class="keyword">FROM</span>     user_log</span><br><span class="line">            <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                        active_date</span><br><span class="line">        ) user_log_1</span><br><span class="line">            <span class="keyword">window</span> <span class="string">`w`</span> <span class="keyword">AS</span></span><br><span class="line">            <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">            (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="keyword">row</span> <span class="keyword">AND</span>  <span class="number">6</span> <span class="keyword">following</span>)</span><br></pre></td></tr></table></figure>
<p>结果为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff	count_now</span><br><span class="line">1	2020-05-01	7	7	1</span><br><span class="line">1	2020-05-02	7	7	2</span><br><span class="line">1	2020-05-04	7	6	3</span><br><span class="line">1	2020-05-05	7	6	4</span><br><span class="line">1	2020-05-06	7	8	5</span><br><span class="line">1	2020-05-07	7	15	6</span><br><span class="line">1	2020-05-08	6	14	7</span><br><span class="line">1	2020-05-09	5	13	8</span><br><span class="line">1	2020-05-10	4	12	9</span><br><span class="line">1	2020-05-11	3	11	10</span><br><span class="line">1	2020-05-14	2	8	11</span><br><span class="line">1	2020-05-22	1	0	12</span><br><span class="line">2	2020-05-02	3	18	1</span><br><span class="line">2	2020-05-04	2	16	2</span><br><span class="line">2	2020-05-20	1	0	3</span><br><span class="line">3	2020-05-02	2	6	1</span><br><span class="line">3	2020-05-08	1	0	2</span><br><span class="line">4	2020-05-02	3	20	1</span><br><span class="line">4	2020-05-08	2	14	2</span><br><span class="line">4	2020-05-22	1	0	3</span><br><span class="line">5	2020-05-10	1	0	1</span><br><span class="line">6	2020-05-01	7	7	1</span><br><span class="line">6	2020-05-02	7	7	2</span><br><span class="line">6	2020-05-04	7	6	3</span><br><span class="line">6	2020-05-05	7	6	4</span><br><span class="line">6	2020-05-06	7	8	5</span><br><span class="line">6	2020-05-07	7	15	6</span><br><span class="line">6	2020-05-08	6	14	7</span><br><span class="line">6	2020-05-09	5	13	8</span><br><span class="line">6	2020-05-10	4	12	9</span><br><span class="line">6	2020-05-11	3	11	10</span><br><span class="line">6	2020-05-14	2	8	11</span><br><span class="line">6	2020-05-22	1	0	12</span><br></pre></td></tr></table></figure>
<p>所以我怀疑hive是在check不超过一个滑窗时，就没有对数据进行排序了。为了验证我的思想，我把id=2的数据增加到了7条，id=3的数据增加到了6条，id=4的数据增加到了5条<br>再次运行不带额外窗口的sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	count	diff</span><br><span class="line">1	2020-05-01	7	7</span><br><span class="line">1	2020-05-02	7	7</span><br><span class="line">1	2020-05-04	7	6</span><br><span class="line">1	2020-05-05	7	6</span><br><span class="line">1	2020-05-06	7	8</span><br><span class="line">1	2020-05-07	7	15</span><br><span class="line">1	2020-05-08	6	14</span><br><span class="line">1	2020-05-09	5	13</span><br><span class="line">1	2020-05-10	4	12</span><br><span class="line">1	2020-05-11	3	11</span><br><span class="line">1	2020-05-14	2	8</span><br><span class="line">1	2020-05-22	1	0</span><br><span class="line">2	2020-05-02	7	18</span><br><span class="line">2	2020-05-04	6	16</span><br><span class="line">2	2020-05-07	5	13</span><br><span class="line">2	2020-05-08	4	12</span><br><span class="line">2	2020-05-09	3	11</span><br><span class="line">2	2020-05-10	2	10</span><br><span class="line">2	2020-05-20	1	0</span><br><span class="line">3	2020-05-01	6	9</span><br><span class="line">3	2020-05-02	5	8</span><br><span class="line">3	2020-05-04	4	6</span><br><span class="line">3	2020-05-07	3	3</span><br><span class="line">3	2020-05-08	2	2</span><br><span class="line">3	2020-05-10	1	0</span><br><span class="line">4	2020-05-01	5	21</span><br><span class="line">4	2020-05-02	5	21</span><br><span class="line">4	2020-05-04	4	20</span><br><span class="line">4	2020-05-08	3	18</span><br><span class="line">4	2020-05-22	2	14</span><br><span class="line">5	2020-05-10	1	0</span><br><span class="line">6	2020-05-01	7	7</span><br><span class="line">6	2020-05-02	7	7</span><br><span class="line">6	2020-05-04	7	6</span><br><span class="line">6	2020-05-05	7	6</span><br><span class="line">6	2020-05-06	7	8</span><br><span class="line">6	2020-05-07	7	15</span><br><span class="line">6	2020-05-08	6	14</span><br><span class="line">6	2020-05-09	5	13</span><br><span class="line">6	2020-05-10	4	12</span><br><span class="line">6	2020-05-11	3	11</span><br><span class="line">6	2020-05-14	2	8</span><br><span class="line">6	2020-05-22	1	0</span><br></pre></td></tr></table></figure>
<p>结果还是有bug；所以为了稳妥起见，还是带上额外的窗口吧<br>完整版的sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (</span><br><span class="line">        <span class="keyword">SELECT</span> user_id,</span><br><span class="line">               active_date,</span><br><span class="line">               <span class="keyword">count</span>(*) <span class="keyword">OVER</span> <span class="string">`w`</span>                                                      <span class="keyword">AS</span> <span class="keyword">count</span>,</span><br><span class="line">               <span class="keyword">datediff</span>(<span class="keyword">last_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>, <span class="keyword">first_value</span>(active_date) <span class="keyword">OVER</span> <span class="string">`w`</span>) <span class="keyword">as</span> diff</span><br><span class="line">              ,<span class="keyword">count</span>(*) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date) <span class="keyword">as</span> count_now</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">               <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                 <span class="keyword">window</span> <span class="string">`w`</span> <span class="keyword">AS</span></span><br><span class="line">                 <span class="comment">-- 按用户分区，按日期排序，选择自己跟未来6天的滑动窗口</span></span><br><span class="line">                 (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date <span class="keyword">rows</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="keyword">row</span> <span class="keyword">AND</span>  <span class="number">6</span> <span class="keyword">following</span>)</span><br><span class="line">     ) user_log2</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">count</span>=<span class="number">7</span></span><br><span class="line"><span class="keyword">AND</span>   diff=<span class="number">6</span> <span class="comment">-- 过滤出滑动窗口里有7天以及差值为6天的数据</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_id</span><br><span class="line">1</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>这里的取巧在于，我们已经知道窗口大小，设置为7天，但是如果我们不知道滑窗大小呢？比如下一题</p>
<ul>
<li>用户的连续活跃最大天数<br>还是以上的数据集，这种时候窗口大小肯定是整个partition，但是我们注意到如果日期是连续的，那么他们的 date 减去 row number，如果得到的结果相同，那么就是连续的数据<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id,</span><br><span class="line">                active_date,</span><br><span class="line">                <span class="keyword">date_sub</span>(active_date, ROW_NUMBER() <span class="keyword">over</span> <span class="string">`w`</span> ) <span class="keyword">as</span> base_date</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">                <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                    <span class="keyword">window</span> <span class="string">`w`</span> <span class="keyword">AS</span> (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date )</span><br></pre></td></tr></table></figure>
结果为<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">user_id	active_date	base_date</span><br><span class="line">1	2020-05-01	2020-04-30</span><br><span class="line">1	2020-05-02	2020-04-30</span><br><span class="line">1	2020-05-04	2020-05-01</span><br><span class="line">1	2020-05-05	2020-05-01</span><br><span class="line">1	2020-05-06	2020-05-01</span><br><span class="line">1	2020-05-07	2020-05-01</span><br><span class="line">1	2020-05-08	2020-05-01</span><br><span class="line">1	2020-05-09	2020-05-01</span><br><span class="line">1	2020-05-10	2020-05-01</span><br><span class="line">1	2020-05-11	2020-05-01</span><br><span class="line">1	2020-05-14	2020-05-03</span><br><span class="line">1	2020-05-22	2020-05-10</span><br><span class="line">2	2020-05-02	2020-05-01</span><br><span class="line">2	2020-05-04	2020-05-02</span><br><span class="line">2	2020-05-07	2020-05-04</span><br><span class="line">2	2020-05-08	2020-05-04</span><br><span class="line">2	2020-05-09	2020-05-04</span><br><span class="line">2	2020-05-10	2020-05-04</span><br><span class="line">2	2020-05-20	2020-05-13</span><br><span class="line">3	2020-05-01	2020-04-30</span><br><span class="line">3	2020-05-02	2020-04-30</span><br><span class="line">3	2020-05-04	2020-05-01</span><br><span class="line">3	2020-05-07	2020-05-03</span><br><span class="line">3	2020-05-08	2020-05-03</span><br><span class="line">3	2020-05-10	2020-05-04</span><br><span class="line">4	2020-05-01	2020-04-30</span><br><span class="line">4	2020-05-02	2020-04-30</span><br><span class="line">4	2020-05-04	2020-05-01</span><br><span class="line">4	2020-05-08	2020-05-04</span><br><span class="line">4	2020-05-22	2020-05-17</span><br><span class="line">5	2020-05-10	2020-05-09</span><br><span class="line">6	2020-05-01	2020-04-30</span><br><span class="line">6	2020-05-02	2020-04-30</span><br><span class="line">6	2020-05-04	2020-05-01</span><br><span class="line">6	2020-05-05	2020-05-01</span><br><span class="line">6	2020-05-06	2020-05-01</span><br><span class="line">6	2020-05-07	2020-05-01</span><br><span class="line">6	2020-05-08	2020-05-01</span><br><span class="line">6	2020-05-09	2020-05-01</span><br><span class="line">6	2020-05-10	2020-05-01</span><br><span class="line">6	2020-05-11	2020-05-01</span><br><span class="line">6	2020-05-14	2020-05-03</span><br><span class="line">6	2020-05-22	2020-05-10</span><br></pre></td></tr></table></figure>
所以完整版也呼之欲出了<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id, <span class="keyword">max</span>(<span class="keyword">count</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span> user_id, <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> <span class="keyword">count</span></span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        (<span class="keyword">SELECT</span> user_id,</span><br><span class="line">                active_date,</span><br><span class="line">                <span class="keyword">date_sub</span>(active_date, ROW_NUMBER() <span class="keyword">over</span> <span class="string">`w`</span> ) <span class="keyword">as</span> base_date</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">                <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                                active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">                    <span class="keyword">window</span> <span class="string">`w`</span> <span class="keyword">AS</span> (<span class="keyword">partition</span> <span class="keyword">BY</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> active_date )</span><br><span class="line">        )user_log_2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id, base_date) user_log_3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br></pre></td></tr></table></figure>
结果为<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user_id	_c1</span><br><span class="line">1	8</span><br><span class="line">2	4</span><br><span class="line">3	2</span><br><span class="line">4	2</span><br><span class="line">5	1</span><br><span class="line">6	8</span><br></pre></td></tr></table></figure>
用这种方法找连续活跃7天的数据也是ok的。</li>
<li>其他的方法<br>我们知道在指定滑窗大小的时候，可以使用row，代表往前或者往后的多少条，是固定的，与业务数据无关；是否可以根据记录的数值，来动态的选择滑窗的大小呢？<br>range就是这样，<br>RANGE BETWEEN 100 PRECEDING AND 200 FOLLOWING ；假如当前值为 200，那么就会选择字段落在100到400间的记录</li>
</ul>
<p>可以把时间转换为数字然后利用range取到一周的区间，看是否有7条记录也ok</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     (</span><br><span class="line">        <span class="keyword">SELECT</span> user_id,</span><br><span class="line">               active_date,</span><br><span class="line">               <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">OVER</span> <span class="string">`w`</span> <span class="keyword">AS</span> count_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">        <span class="comment">-- 首先去重</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="keyword">SELECT</span>   user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                    <span class="keyword">FROM</span>     user_log</span><br><span class="line">                    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id,</span><br><span class="line">                             active_date</span><br><span class="line">                ) user_log_1</span><br><span class="line">        <span class="keyword">window</span> <span class="string">`w`</span></span><br><span class="line">        <span class="comment">-- 取一个range 区间，是按照order by 来排序的</span></span><br><span class="line">        <span class="keyword">as</span> (<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">unix_timestamp</span>(active_date, <span class="string">'yyyy-MM-dd'</span>) <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">518400</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>)</span><br><span class="line">     ) user_log2</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> count_date = <span class="number">7</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_id</span><br><span class="line">1</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>说到底，这是一种如何定义窗口跟利用hql的语言使用窗口的语言；来，我们看看如何在spark、flink这些语言中，定义与使用窗口</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics" target="_blank" rel="noopener">hive官网说明</a></li>
<li><a href="http://shzhangji.com/blog/2017/09/04/hive-window-and-analytical-functions/" target="_blank" rel="noopener">http://shzhangji.com/blog/2017/09/04/hive-window-and-analytical-functions/</a></li>
<li><a href="http://lxw1234.com/archives/tag/hive-window-functions" target="_blank" rel="noopener">http://lxw1234.com/archives/tag/hive-window-functions</a><br>重点可以看他的window specification说明</li>
<li><a href="https://bigdataprogrammers.com/windowing-functions-in-hive/" target="_blank" rel="noopener">https://bigdataprogrammers.com/windowing-functions-in-hive/</a> </li>
</ul>
<p>关于如何使用range window frame</p>
<ul>
<li><a href="http://bill.crook.io/blog/2014/10/24/date-based-windowing-functions-in-hive/" target="_blank" rel="noopener">http://bill.crook.io/blog/2014/10/24/date-based-windowing-functions-in-hive/</a></li>
</ul>
<blockquote>
<p>The window ranges today are numeric constants, whereas, in the spec, you can have arbitrary numerical expressions. And in Hive, you don’t have date intervals. So if you want to do date-based windows, you pretty much have to break down the date into components, and treat each component as a int.</p>
</blockquote>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/hive/">hive</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/07/11/bigdata/hive-order-by/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">hive order by</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/07/09/tools/vscode/">
        <span class="next-text nav-default">vscode</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
    <div style="text-align:center;">
        <button class="btn" id="load-disqus" onclick="disqus.load();">加载 Disqus 评论</button>
    </div>
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2020
    <span class="footer-author">hustwolf.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear" target="_blank" rel="noopener">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    

<script type="text/javascript">
  var disqus_shortname = 'hustwolf';
  var disqus_identifier = '2020/07/11/bigdata/hive-window-function/';

  var disqus_title = "hive中的window function详解";


  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
